<html>
    <head>
        <script type='text/javascript' src='https://cdn.scaledrone.com/scaledrone.min.js'></script>
        <meta charset="utf-8">
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
        <title>Moderador v1.0</title>
        <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 13px;
      display: flex;
      flex-direction: column;
      max-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .members-count,
    .members-list,
    .messages {
      border: 1px solid #e4e4e4;
      padding: 15px;
      margin-bottom: 15px;
    }
    .messages {
      flex-shrink: 1;
      overflow: auto;
    }
    .message {
      padding: 5px 0;
    }
    .message .member {
      display: inline-block;
    }
    .member {
      padding-right: 10px;
      position: relative;
    }
/*
    .message-form {
      display: flex;
      flex-shrink: 0;
    }
*/
/*
    .message-form__input {
      flex-grow: 1;
      border: 1px solid #dfdfdf;
      padding: 10px 15px;
      font-size: 16px;
    }
*/
    .message-form__button {
        font-size: 20;
        margin: 10px;
        margin-left: 37%;
        margin-right: 50%
        margin: 300 auto;
        float: left;
    }
  </style>
    </head>
    <body>
        <script type="text/javascript" src="cordova.js"></script>
        <h1 style="font-family: sans-serif"><center>Bienvenido</center></h1>
        <div id="result"></div>
        <label id="usuario" style="font-family: sans-serif; font-size: 30;">
            <center>
                <script>
                    document.getElementById('usuario').style.display = "block"; 
                    document.getElementById('usuario').style.textAlign = "center"
                    document.getElementById('usuario').textContent = localStorage.getItem("Name").toString(); 
                </script>
            </center>
        </label>
        <center>
            <form class="message-form" onsubmit="return false;">
                <input class="message-form__input" placeholder="" type="hidden" disabled/>
                <center><input class="message-form__button" value="Comentar" type="submit" placeholder=""/></center>
            </form>
        </center>
        <div class="members-count">-</div>
        <div class="members-list">-</div>
        <div class="messages"></div>
        <script>
        const CLIENT_ID = '9ANRyHguEck9aoQj';

            const drone = new ScaleDrone(CLIENT_ID, {
              data: { // Will be sent out as clientData via events
                name: localStorage.getItem("Name").toString(),
              },
            });


            let members = [];

            var x = localStorage.getItem("Name").toLocaleLowerCase().toString(); 
            var admin = "admin"; 
            if(admin.localeCompare(x) == 0) { 

            }


            drone.on('open', error => {
              if (error) {
                return console.error(error);
              }
              console.log('Successfully connected to Scaledrone');

              const room = drone.subscribe('observable-room');
              room.on('open', error => {
                if (error) {
                  return console.error(error);
                }
                console.log('Successfully joined room');
              });

              room.on('members', m => {
                members = m;
                updateMembersDOM();
              });

              room.on('member_join', member => {
                members.push(member);
                updateMembersDOM();
              });

              room.on('member_leave', ({id}) => {
                const index = members.findIndex(member => member.id === id);
                members.splice(index, 1);
                updateMembersDOM();
              });

              room.on('data', (text, member) => {
                if (member) {
                  addMessageToListDOM(text, member);
                } else {
                  // Message is from server
                }
              });
            });

            drone.on('close', event => {
              console.log('Connection was closed', event);
            });

            drone.on('error', error => {
              console.error(error);
            });


            //------------- DOM STUFF

            const DOM = {
              membersCount: document.querySelector('.members-count'),
              membersList: document.querySelector('.members-list'),
              messages: document.querySelector('.messages'),
              input: document.querySelector('.message-form__input'),
              form: document.querySelector('.message-form'),
            };

            DOM.form.addEventListener('submit', sendMessage);

            function sendMessage() {
              const value = DOM.input.value;
            //  if (value === '') {
            //    return;
            //  }
              DOM.input.value = "";
              drone.publish({
                room: 'observable-room',
                message: "value",
              });
            }

            function createMemberElement(member) {
              const { name, color } = member.clientData;
              const el = document.createElement('div');
              el.appendChild(document.createTextNode(name));
              el.className = 'member';
              el.style.color = color;
              return el;
            }

            function updateMembersDOM() {
              DOM.membersCount.innerText = `${members.length} usuarios en la App:`;
              DOM.membersList.innerHTML = '';
              members.forEach(member =>
                DOM.membersList.appendChild(createMemberElement(member))
              );
            }

            function createMessageElement(text, member) {
              const el = document.createElement('div');
              el.appendChild(createMemberElement(member));
              el.appendChild(document.createTextNode("Quiere comentar"));
              el.className = 'message';
              return el;
            }

            function addMessageToListDOM(text, member) {
              const el = DOM.messages;
              const wasTop = el.scrollTop === el.scrollHeight - el.clientHeight;
              el.appendChild(createMessageElement("agregar", member));
              if (wasTop) {
                el.scrollTop = el.scrollHeight - el.clientHeight;
              }
            }
        </script>
    </body>
</html>
